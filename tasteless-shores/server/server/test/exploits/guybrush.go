package main

import (
	"encoding/binary"
	"fmt"
	"io"
	"log"
	"net"
	"time"
	"ts/server/ts"
)

type rng struct {
	x, y, z uint8
	a       uint8
}

func (r *rng) i() uint8 {
	var t uint8 = r.x ^ (r.x << 4)
	r.x = r.y
	r.y = r.z
	r.z = r.a
	r.a = r.z ^ t ^ (r.z >> 1) ^ (t << 1)
	return r.a
}

var insultKeys = []string{
	"You fight like a dairy Farmer!",
	"This is the END for you, you gutter crawling cur!",
	"I've spoken with apes more polite than you!",
	"Soon you'll be wearing my sword like a shish kebab!",
	"People fall at my feet when they see me coming!",
	"I'm not going to take your insolence sitting down!",
	"I once owned a dog that was smarter than you.",
	"Nobody's ever drawn blood from me and nobody ever will.",
	"Have you stopped wearing diapers yet?",
	"There are no words for how disgusting you are.",
	"You make me want to puke.",
	"My handkerchief will wipe up your blood!",
	"I got this scar on my face during a mighty struggle!",
	"I've heard you are a contemptible sneak.",
	"You're no match for my brains, you poor fool.",
	"You have the manners of a beggar.",
	"I beat the Sword Master!",
	"Now I know what filth and stupidity really are.",
	"Every word you say to me is stupid.",
	"I've got a long, sharp lesson for you to learn today.",
	"I will milk every drop of blood from your body!",
	"I've got the courage and skill of a master swordsman.",
	"My tongue is sharper than any sword.",
	"My name is feared in every dirty corner of this island!",
	"My wisest enemies run away at the first sight of me!",
	"Only once have I met such a coward!",
	"If your brother's like you, better to marry a pig.",
	"No one will ever catch ME fighting as badly as you do.",
	"My last fight ended with my hands covered with blood.",
	"I hope you have a boat ready for a quick escape.",
	"My sword is famous all over the Caribbean!",
	"You are a pain in the backside, sir!",
	"I usually see people like you passed-out on tavern floors.",
	"There are no clever moves that can help you now.",
	"Every enemy I've met I've annihilated!",
	"You're as repulsive as a monkey in a negligee.",
	"Killing you would be justifiable homicide!",
	"You're the ugliest monster ever created!",
	"I'll skewer you like a sow at a buffet!",
	"Would you like to be buried, or cremated?",
	"Coming face to face with me must leave you petrified!",
	"When your father first saw you, he must have been mortified!",
	"You can't match my witty repartee!",
	"I have never seen such clumsy swordplay!",
	"En garde! Touché!	Your mother wears a toupee!",
	"I can't rest 'til you've been exterminated!",
	"I'll leave you devastated, mutilated, and perforated!",
	"Heaven preserve me! You look like something that's died!",
	"I'll hound you night and day!",
	"My attacks have left entire islands depopulated!",
	"You have the sex appeal of a Shar-Pei.",
	"When I'm done, your body will be rotted and putrified!",
	"Your looks would make pigs nauseated.",
	"Your lips look like they belong on catch of the day!",
	"I give you a choice. You can be gutted, or decapitated!",
	"Never before have I seen someone so sissified!",
	"You're a disgrace to your species, you're so undignified!",
	"Nothing can stop me from blowing you away!",
	"I have never lost to a melee!",
	"Your mother wears a toupee!",
	"My skills with a sword are highly venerated!",
	"Your stench would make an outhouse cleaner irritated!",
	"I can't tell you which of my traits leaves you most intimidated.",
	"Nothing on this Earth can save your sorry hide!",
	"You'll find I am dogged and relentless to my prey!",
}
var insults = map[string]string{
	"You fight like a dairy Farmer!":                               "How appropriate. You fight like a cow!",
	"This is the END for you, you gutter crawling cur!":            "And I've got a little TIP for you, get the POINT?",
	"I've spoken with apes more polite than you!":                  "I'm glad to hear you attended your family reunion!",
	"Soon you'll be wearing my sword like a shish kebab!":          "First you'd better stop waving it like a feather duster.",
	"People fall at my feet when they see me coming!":              "Even BEFORE they smell your breath?",
	"I'm not going to take your insolence sitting down!":           "Your hemorrhoids are flaring up again eh?",
	"I once owned a dog that was smarter than you.":                "He must have taught you everything you know.",
	"Nobody's ever drawn blood from me and nobody ever will.":      "You run THAT fast?",
	"Have you stopped wearing diapers yet?":                        "Why? Did you want to borrow one?",
	"There are no words for how disgusting you are.":               "Yes there are. You just never learned them.",
	"You make me want to puke.":                                    "You make me think somebody already did.",
	"My handkerchief will wipe up your blood!":                     "So you got that job as janitor, after all.",
	"I got this scar on my face during a mighty struggle!":         "I hope now you've learned to stop picking your nose.",
	"I've heard you are a contemptible sneak.":                     "Too bad no one's ever heard of YOU at all.",
	"You're no match for my brains, you poor fool.":                "I'd be in real trouble if you ever used them.",
	"You have the manners of a beggar.":                            "I wanted to make sure you'd feel comfortable with me.",
	"I beat the Sword Master!":                                     "Are you still wearing this lousy shirt?",
	"Now I know what filth and stupidity really are.":              "I'm glad to hear you attended your family reunion.",
	"Every word you say to me is stupid.":                          "I wanted to make sure you'd feel comfortable with me.",
	"I've got a long, sharp lesson for you to learn today.":        "And I've got a little TIP for you. Get the POINT?",
	"I will milk every drop of blood from your body!":              "How appropriate, you fight like a cow!",
	"I've got the courage and skill of a master swordsman.":        "I'd be in real trouble if you ever used them.",
	"My tongue is sharper than any sword.":                         "First, you'd better stop waving it like a feather-duster.",
	"My name is feared in every dirty corner of this island!":      "So you got that job as a janitor, after all.",
	"My wisest enemies run away at the first sight of me!":         "Even BEFORE they smell your breath?",
	"Only once have I met such a coward!":                          "He must have taught you everything you know.",
	"If your brother's like you, better to marry a pig.":           "You make me think somebody already did.",
	"No one will ever catch ME fighting as badly as you do.":       "You run THAT fast?",
	"My last fight ended with my hands covered with blood.":        "I hope now you've learned to stop picking your nose.",
	"I hope you have a boat ready for a quick escape.":             "Why, did you want to borrow one?",
	"My sword is famous all over the Caribbean!":                   "Too bad no one's ever heard of YOU at all.",
	"You are a pain in the backside, sir!":                         "Your hemorrhoids are flaring up again, eh?",
	"I usually see people like you passed-out on tavern floors.":   "Even BEFORE they smell your breath?",
	"There are no clever moves that can help you now.":             "Yes there are. You just never learned them.",
	"Every enemy I've met I've annihilated!":                       "With your breath, I'm sure they all suffocated.",
	"You're as repulsive as a monkey in a negligee.":               "I look THAT much like your fiancée?",
	"Killing you would be justifiable homicide!":                   "Then killing you must be justifiable fungicide.",
	"You're the ugliest monster ever created!":                     " If you don't count all the ones you've dated.",
	"I'll skewer you like a sow at a buffet!":                      "When I'm done with you, you'll be a boneless filet.",
	"Would you like to be buried, or cremated?":                    "With you around, I'd prefer to be fumigated.",
	"Coming face to face with me must leave you petrified!":        "Is that your face? I thought it was your backside.",
	"When your father first saw you, he must have been mortified!": "At least mine can be identified.",
	"You can't match my witty repartee!":                           "I could, if you would use some breath spray.",
	"I have never seen such clumsy swordplay!":                     "You would have, but you were always running away.",
	"En garde! Touché!	Your mother wears a toupee!": "My skills with a sword are highly venerated!	Too bad they're all fabricated.",
	"I can't rest 'til you've been exterminated!":                      "Then perhaps you should switch to decaffeinated.",
	"I'll leave you devastated, mutilated, and perforated!":            "Your odor alone makes me aggravated, agitated, and infuriated.",
	"Heaven preserve me! You look like something that's died!":         "The only way you'll be preserved is in formaldehyde.",
	"I'll hound you night and day!":                                    "Then be a good dog. Sit! Stay!",
	"My attacks have left entire islands depopulated!":                 "With your breath, I'm sure they all suffocated.",
	"You have the sex appeal of a Shar-Pei.":                           "I look THAT much like your fiancée?",
	"When I'm done, your body will be rotted and putrified!":           "Then killing you must be justifiable fungicide.",
	"Your looks would make pigs nauseated.":                            "If you don't count all the ones you've dated.",
	"Your lips look like they belong on catch of the day!":             "When I'm done with you, you'll be a boneless filet.",
	"I give you a choice. You can be gutted, or decapitated!":          "With you around, I'd prefer to be fumigated.",
	"Never before have I seen someone so sissified!":                   "Is that your face? I thought it was your backside.",
	"You're a disgrace to your species, you're so undignified!":        "At least mine can be identified.",
	"Nothing can stop me from blowing you away!":                       "I could, if you would use some breath spray.",
	"I have never lost to a melee!":                                    "You would have, but you were always running away.",
	"Your mother wears a toupee!":                                      "Oh, that is so cliché.",
	"My skills with a sword are highly venerated!":                     "Too bad they're all fabricated.",
	"Your stench would make an outhouse cleaner irritated!":            "Then perhaps you should switch to decaffeinated.",
	"I can't tell you which of my traits leaves you most intimidated.": "Your odor alone makes me aggravated, agitated, and infuriated.",
	"Nothing on this Earth can save your sorry hide!":                  "The only way you'll be preserved is in formaldehyde.",
	"You'll find I am dogged and relentless to my prey!":               "Then be a good dog. Sit! Stay!",
}

func guybrush() {
	c, err := net.Dial("tcp", "localhost:31337")
	if err != nil {
		log.Fatal(err)
	}

	fmt.Fprintf(c, "pirates!\x00\x03ccm\x00")
	fmt.Fprintf(c, "\x22\x08")
	log.Println("joined")

	msgs := make(chan ts.ServerMessageChat, 10)

	go func() {
		for {
			msg, err := ts.ReadServerMessage(c)
			if err != nil {
				panic(err)
			}
			switch msg := msg.(type) {
			case ts.ServerMessageFlag:
				log.Println("Got flag", msg)
			case ts.ServerMessageMark:
				log.Println("Got marker", msg)
			case ts.ServerMessageChat:
				msgs <- msg
			}
			// log.Printf("%#v", msg)
		}
	}()

	time.Sleep(100 * time.Millisecond)

	var writeString = func(r io.Writer, data string) error {
		if err := binary.Write(r, binary.LittleEndian, uint8(len(data))); err != nil {
			return err
		}

		_, err := r.Write([]byte(data))
		return err
	}

	time.Sleep(1000 * time.Millisecond)

	binary.Write(c, binary.LittleEndian, uint8(0x45))
	binary.Write(c, binary.LittleEndian, float64(524))
	binary.Write(c, binary.LittleEndian, float64(3.5))
	binary.Write(c, binary.LittleEndian, float64(-563))
	binary.Write(c, binary.LittleEndian, float64(1))

	time.Sleep(1000 * time.Millisecond)

	binary.Write(c, binary.LittleEndian, uint8(0x50))   // chat
	binary.Write(c, binary.LittleEndian, uint64(31337)) // guybrush
	writeString(c, "hi there")

	chat := <-msgs
	num := uint8(0)
	for i, insult := range insultKeys {
		if insult == chat.Msg {
			num = uint8(i)
		}
	}

	log.Println("insult: ", num)

	var candidates []rng
	for x := uint8(0); x <= 255; x++ {
		for y := uint8(0); y <= 255; y++ {
			for z := uint8(0); z <= 255; z++ {
				var r = rng{
					x: x, y: y, z: z,
				}

				if r.i()%64 == num {
					candidates = append(candidates, r)
				}
				if z == 255 {
					break
				}
			}
			if y == 255 {
				break
			}
		}
		if x == 255 {
			break
		}
	}

	log.Println(len(candidates))

	binary.Write(c, binary.LittleEndian, uint8(0x50))   // chat
	binary.Write(c, binary.LittleEndian, uint64(31337)) // guybrush
	writeString(c, "hi")

	chat = <-msgs
	num = uint8(0)
	for i, insult := range insultKeys {
		if insult == chat.Msg {
			num = uint8(i)
		}
	}

	log.Println("insult: ", num)

	oldC := make([]rng, len(candidates))
	copy(oldC, candidates)
	candidates = []rng{}
	for _, c := range oldC {
		if c.i()%64 == num {
			candidates = append(candidates, c)
		}
	}

	for len(candidates) > 1 {

		binary.Write(c, binary.LittleEndian, uint8(0x50))   // chat
		binary.Write(c, binary.LittleEndian, uint64(31337)) // guybrush
		writeString(c, "hi")

		chat = <-msgs
		num = uint8(0)
		for i, insult := range insultKeys {
			if insult == chat.Msg {
				num = uint8(i)
			}
		}

		log.Println("insult: ", num)

		oldC = make([]rng, len(candidates))
		copy(oldC, candidates)
		candidates = []rng{}
		for _, c := range oldC {
			if c.i()%64 == num {
				candidates = append(candidates, c)
			}
		}

		log.Println(len(candidates))
	}

	for i := 0; i < 30; i++ {
		nexti := insultKeys[candidates[0].i()%64]
		answer := insults[nexti]
		log.Println(nexti, answer)

		binary.Write(c, binary.LittleEndian, uint8(0x50))   // chat
		binary.Write(c, binary.LittleEndian, uint64(31337)) // guybrush
		writeString(c, answer)

		chat = <-msgs
		log.Println(chat)
	}

	time.Sleep(5000 * time.Millisecond)

	binary.Write(c, binary.LittleEndian, uint8(0x76))
	fmt.Fprintf(c, "\x0dFLAG_BIGWHOOP")

	binary.Write(c, binary.LittleEndian, uint8(0x76))
	fmt.Fprintf(c, "\x0dFLAG_BIGWHOOP")

	binary.Write(c, binary.LittleEndian, uint8(0x76))
	fmt.Fprintf(c, "\x0dFLAG_BIGWHOOP")

	time.Sleep(20 * time.Second)
}
